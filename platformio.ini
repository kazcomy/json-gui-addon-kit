; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

# Default environments: exclude 'native' so that a plain `pio run` only
# builds MCU firmware targets. The 'native' environment is reserved for
# unit tests (Unity harness) and should be invoked explicitly when needed.
[platformio]
default_envs = gfx_slave, gfx_master

[env:gfx_slave]
platform = ch32v
board = genericCH32V003F4P6
framework = ch32v003fun
build_type = release
upload_protocol = custom
extra_scripts = tool/program_on_remote.py
debug_tool = custom
; Launch SSH tunnel + remote OpenOCD via Python script
; invoke via python explicitly to avoid exec issues
debug_server =
    /usr/bin/python3
    $PROJECT_DIR/tool/remote_debug_server.py
    --host
    ${sysenv.REMOTE_HOST_GFX_SLAVE}
; PlatformIO gdb will connect to localhost:3333 (forwarded)
debug_port = :3333
debug_init_break = tbreak main
debug_load_mode = always
; Load GDB hooks for auto-shutdown
debug_extra_cmds = 
    source $PROJECT_DIR/tool/gdb_hooks.gdb

lib_deps =

; Common flags
build_flags =
    -I include/common
    -I include/slave
    -D FUNCONF_DISABLE_SSD1306=1
    -D USE_PAGE_BUFFER=1
    -Os
    -flto
    -flto-partition=one
    -fmerge-all-constants
    -fmerge-constants
    -fno-unroll-loops
    -fno-tree-vectorize
    -fno-tree-slp-vectorize
    -fno-asynchronous-unwind-tables
    -fno-unwind-tables
    -fno-exceptions
    -fno-stack-protector
    -ffunction-sections
    -fdata-sections
    -fomit-frame-pointer
    -fno-inline-functions-called-once
    -fno-jump-tables
    -fuse-linker-plugin
    -msave-restore
    -march=rv32ec
    -mabi=ilp32e
    -mrelax
    -specs=nano.specs
    -specs=nosys.specs
    -Wall
    -Wl,--gc-sections,--relax,--print-memory-usage

debug_build_flags =
    -Os -g1

; Source files filter - include specific C files for each environment
build_src_filter =
    +<slave/*.c>
    +<common/*.c>

monitor_speed = 115200

[env:gfx_slave_su]
; Analysis env: generate per-function stack usage (.su) files
platform = ch32v
board = genericCH32V003F4P6
framework = ch32v003fun
build_type = release
upload_protocol = custom
extra_scripts = tool/program_on_remote.py
; Disable LTO/inlining that can hide or move stack frames; enable -fstack-usage
build_unflags =
    -flto
    -fuse-linker-plugin
build_flags =
    -I include/common
    -I include/slave
    -D FUNCONF_DISABLE_SSD1306=1
    -D USE_PAGE_BUFFER=1
    -Os
    -fstack-usage
    -fno-lto
    -fno-use-linker-plugin
    -fno-inline-functions-called-once
    -fno-ipa-cp
    -fno-ipa-sra
    -fno-unroll-loops
    -fno-tree-vectorize
    -fno-tree-slp-vectorize
    -fno-asynchronous-unwind-tables
    -fno-unwind-tables
    -fno-exceptions
    -fno-stack-protector
    -ffunction-sections
    -fdata-sections
    -fomit-frame-pointer
    -fno-jump-tables
    -msave-restore
    -march=rv32ec
    -mabi=ilp32e
    -mrelax
    -specs=nano.specs
    -specs=nosys.specs
    -Wall
    -Wl,--gc-sections,--relax,--print-memory-usage

build_src_filter =
    +<slave/*.c>
    +<common/*.c>

[env:native]
platform = native
test_framework = unity
build_flags =
    -D UNIT_TEST=1
    -I test/hal_stub/
    -I include/common
    -I include/slave
    -I include/master
test_build_src = yes
test_filter = test_state
; Native unit test environment: exclude hardware/renderer sources; no standalone main (Unity provides entry)
build_src_filter = \
    +<slave/ui_protocol.c> \
    +<slave/ui_input.c> \
    +<slave/ui_focus.c> \
    +<slave/ui_layout.c> \
    +<slave/ui_numeric.c> \
    +<slave/ui_runtime.c> \
    +<slave/ui_tree.c> \
    +<common/cobs.c>



[env:gfx_master]
; gfx_master: Host/master that sends SPI commands and JSON to the slave.
platform = ch32v
board = genericCH32V003F4P6
framework = ch32v003fun
build_type = debug ; enable debug info for remote GDB
upload_protocol = custom
extra_scripts = tool/program_on_remote2.py
debug_tool = custom
; Launch SSH tunnel + remote OpenOCD via Python script
; invoke via python explicitly to avoid exec issues
debug_server =
    /usr/bin/python3
    $PROJECT_DIR/tool/remote_debug_server.py
    --host
    ${sysenv.REMOTE_HOST_GFX_MASTER}
; PlatformIO gdb will connect to localhost:3333 (forwarded)
debug_port = :3333
debug_init_break = tbreak main
debug_load_mode = always
; Load GDB hooks for auto-shutdown
debug_extra_cmds = 
    source $PROJECT_DIR/tool/gdb_hooks.gdb

lib_deps =

; Common flags
build_flags =
  -DDEMO_JSON_SCENARIO_MULTI
    -I include/common
    -I include/master
    -I lib/CH32V003_lib_i2c/
    -D FUNCONF_DISABLE_SSD1306=1
    -D FUNCONF_USE_CLK_SEC=0
    -D MASTER_HPRE=RCC_HPRE_DIV3
        -D FUNCONF_USE_DEBUGPRINTF=1
    -D USE_PAGE_BUFFER=1
    -Os
    -flto
    -fmerge-all-constants
    -fno-unroll-loops
    -fno-tree-vectorize
    -fno-asynchronous-unwind-tables
    -fno-exceptions
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections,--print-memory-usage
    -Wall
    -fno-jump-tables

debug_build_flags =
    -Os -g3 -ggdb3 -fno-omit-frame-pointer

build_src_filter =
    +<master/*.c>
    +<common/*.c>

monitor_speed = 115200
